'use strict';

const Service = require('egg').Service;

class HaiguiService extends Service {

  async algo(symbol, timeframe = '1d', limit = 20) {

    // 计算康安奇通道和ATR
    const ohlcvList = await this.ctx.service.apiCcxt.OHLCV(symbol, timeframe, limit);
    const ticker = await this.ctx.service.apiCcxt.platform().fetchTicker(symbol);
    const trList = []; const highList = []; const lowList = [];
    let forward;
    if (!ohlcvList) return null;
    for (const ohlcv of ohlcvList) {
      if (forward !== undefined) {
        const tr = Math.max(ohlcv.high - ohlcv.low, Math.abs(ohlcv.high - forward.close), Math.abs(forward.close - ohlcv.low));
        trList.push(tr);
      }
      forward = ohlcv;
      highList.push(ohlcv.high);
      lowList.push(ohlcv.low);
    }
    if (ticker) {
      trList.push(Math.max(ticker.high - ticker.low, Math.abs(ticker.high - forward.close), Math.abs(forward.close - ticker.low)));
    }
    const avg = function(array) {
      const len = array.length;
      let sum = 0;
      for (let i = 0; i < len; i++) {
        sum += array[i];
      }
      return Math.floor(sum / len);
    };
    const atr = avg(trList);
    return {
      atr,
      don_open: Math.max(...highList),
      don_close: Math.min(...lowList),
    };
  }
}

module.exports = HaiguiService;
